<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Go/No-Go Reaction Test</title>
<style>
  /* … (all your existing styles unchanged) … */
  #postControls { margin-top:20px; display:none; text-align:center; }
</style>
</head>
<body>
<h2>Go/No-Go Reaction Test</h2>
<p>Press <strong>SPACEBAR</strong> or <strong>Tap</strong> when the screen turns
  <span style="color:green;">green</span>. Do <strong>NOT</strong> respond when red.</p>

<div id="countdown">Starting in <span id="count">3</span>…</div>
<div id="testBox">WAIT</div>

<div id="controls">
  <button id="pauseBtn"  class="button">Pause</button>
  <button id="resumeBtn" class="button" disabled>Resume</button>
</div>

<div id="metrics">
  <p>Trial: <span id="trialNum">0</span> / 20</p>
  <p>Hits: <span id="hits">0</span> | Misses: <span id="misses">0</span> |
     False Alarms: <span id="falseAlarms">0</span></p>
  <p>Average Reaction Time: <span id="avgRT">-</span></p>
</div>

<div id="results"></div>

<!-- Submit / Re-take appear only after test ends -->
<div id="postControls">
  <button id="submitBtn" class="button">Submit</button>
  <button id="retakeBtn" class="button">Re-take</button>
</div>

<script>
/* ---------- element handles ---------- */
const testBox = document.getElementById("testBox");
const trialNum = document.getElementById("trialNum");
const hitsEl   = document.getElementById("hits");
const missesEl = document.getElementById("misses");
const faEl     = document.getElementById("falseAlarms");
const avgRT    = document.getElementById("avgRT");
const countdownEl = document.getElementById("count");
const pauseBtn = document.getElementById("pauseBtn");
const resumeBtn= document.getElementById("resumeBtn");
const results  = document.getElementById("results");
const postCtrls= document.getElementById("postControls");
const submitBtn= document.getElementById("submitBtn");
const retakeBtn= document.getElementById("retakeBtn");

/* ---------- task-wide state ---------- */
const TRIALS           = 20;
const goColor = 'green', noGoColor = 'red';
let trialCount, listening, paused, startTime, isGo, data;

/* ---------- helpers ---------- */
const initData = () => ({
  reactionTimes: [], falseAlarms:0, misses:0, correctHits:0,
  totalGo:0, totalNoGo:0
});

const updateMetrics = () => {
  trialNum.textContent  = trialCount;
  hitsEl.textContent    = data.correctHits;
  missesEl.textContent  = data.misses;
  faEl.textContent      = data.falseAlarms;
  avgRT.textContent     = data.reactionTimes.length
        ? Math.round(data.reactionTimes.reduce((a,b)=>a+b,0)/data.reactionTimes.length) + " ms" : "-";
};

const flashBox = () => {
  testBox.classList.add("flash");
  setTimeout(()=>testBox.classList.remove("flash"),200);
};

/* ---------- core flow ---------- */
function countdownStart(cb){
  let c=3;
  const t=setInterval(()=>{
    countdownEl.textContent=c;
    if(--c<0){ clearInterval(t); document.getElementById("countdown").style.display="none"; cb(); }
  },1000);
}

function nextTrial(){
  if(paused) return;
  if(trialCount>=TRIALS){ finishTest(); return; }

  trialCount++; listening=false; updateMetrics();
  isGo = Math.random() > 0.4;
  isGo ? data.totalGo++ : data.totalNoGo++;

  testBox.textContent="WAIT"; testBox.style.backgroundColor="gray";

  setTimeout(()=>{
    if(paused) return;
    testBox.style.backgroundColor = isGo ? goColor : noGoColor;
    testBox.textContent  = isGo ? "GO" : "NO";
    startTime = performance.now();
    listening = true;

    setTimeout(()=>{
      if(listening){ if(isGo) data.misses++; listening=false; updateMetrics(); }
      nextTrial();
    },1500);
  }, 800 + Math.random()*1200);
}

function registerResponse(){
  if(!listening) return;
  flashBox();
  const rt = performance.now() - startTime;
  const color = testBox.style.backgroundColor;

  if(color===goColor){
    data.reactionTimes.push(rt);
    data.correctHits++;
  }else{
    data.falseAlarms++;
  }
  listening=false; updateMetrics();
}

/* ---------- finish & post-test controls ---------- */
function finishTest(){
  paused=true; pauseBtn.disabled=true; resumeBtn.disabled=true;
  testBox.textContent="DONE"; testBox.style.backgroundColor="#4b5563";

  const avg = Math.round(data.reactionTimes.reduce((a,b)=>a+b,0)/(data.reactionTimes.length||1));
  results.innerHTML = `<h3>Final Results</h3>
    <p>Avg Reaction Time: ${avg} ms</p>
    <p>Correct Hits: ${data.correctHits} / ${data.totalGo}</p>
    <p>False Alarms: ${data.falseAlarms} / ${data.totalNoGo}</p>
    <p>Misses: ${data.misses}</p>`;

  postCtrls.style.display="block";
}

submitBtn.onclick = () => {
  window.parent.postMessage({ type:"gonogo_results", data }, "*");
  submitBtn.disabled = true;
};

retakeBtn.onclick = () => resetTask();

/* ---------- reset for Re-take ---------- */
function resetTask(){
  trialCount = 0; paused=false; listening=false; data = initData();
  results.innerHTML=""; postCtrls.style.display="none";
  pauseBtn.disabled=false; resumeBtn.disabled=true;
  document.getElementById("countdown").style.display="block";
  countdownEl.textContent="3";
  testBox.textContent="WAIT"; testBox.style.backgroundColor="gray";
  updateMetrics();
  countdownStart(nextTrial);
}

/* ---------- input handlers ---------- */
document.body.onkeyup = e => { if(e.code==="Space") registerResponse(); };
testBox.addEventListener("click", registerResponse);
testBox.addEventListener("touchstart", e=>{ e.preventDefault(); registerResponse(); });

pauseBtn.onclick  = ()=>{ paused=true; pauseBtn.disabled=true; resumeBtn.disabled=false;
                          testBox.textContent="PAUSED"; testBox.style.backgroundColor="#9ca3af"; };

resumeBtn.onclick = ()=>{ paused=false; pauseBtn.disabled=false; resumeBtn.disabled=true;
                          testBox.textContent="READY"; nextTrial(); };

/* ---------- kick-off ---------- */
resetTask();   /* initial launch */
</script>
</body>
</html>
